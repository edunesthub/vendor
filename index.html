<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="Chawp - Sleek Food Delivery">
    <meta name="author" content="VON">
    <meta name="theme-color" content="#1c1c1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="img/icon-192x192.png">
    <link rel="apple-touch-icon" href="img/icon-192x192.png">
    <title>Chawp Vendor Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="/manifest.json">
    
    <style>
        /* Force dark status bar text on iOS */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(env(safe-area-inset-bottom) + 5rem);
                margin-top: 0;
            }
        }
        
        body {
            background: #1c1c1e;
            color: #ffffff;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0 0 5rem;
            min-height: 100vh;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body::-webkit-scrollbar, 
        *::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }
        
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        div, section, nav, main, aside, article, form {
            scrollbar-width: none;
        }
        
        .container {
            max-width: 48rem;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .section {
            background: #252527;
            border-radius: 1.25rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.5);
            transition: transform 0.15s ease-out, opacity 0.15s ease-out;
            width: 100%;
            max-width: 36rem;
            text-align: center;
            will-change: transform, opacity;
        }
        
        .section.hidden {
            transform: translateY(1rem);
            opacity: 0;
            pointer-events: none;
        }
        
        h1 {
            font-size: clamp(1.75rem, 5vw, 2.5rem);
            font-weight: 700;
            letter-spacing: -1px;
            margin: 0 0 1rem;
            background: linear-gradient(45deg, #007aff, #34c759, #007aff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0.25rem 1.25rem rgba(0, 122, 255, 0.2);
        }
        
        h2 {
            font-size: clamp(1.25rem, 4vw, 1.5rem);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        p {
            font-size: clamp(0.9rem, 3vw, 1rem);
            opacity: 0.9;
            margin: 0 0 1rem;
        }
        
        .btn {
            background: #007aff;
            color: #fff;
            padding: 1rem 1.5rem;
            border-radius: 0.875rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.15s ease-out;
            border: none;
            cursor: pointer;
            width: 100%;
            max-width: 20rem;
            margin: 0.5rem auto;
            display: block;
            font-size: 1rem;
            min-height: 3rem;
        }
        
        .btn:hover {
            background: #0062cc;
            transform: translateY(-0.1rem);
        }
        
        .btn-secondary {
            background: #ff3b30;
        }
        
        .btn-secondary:hover {
            background: #dc2626;
        }
        
        .btn-edit {
            background: #34c759;
        }
        
        .btn-edit:hover {
            background: #2ea44f;
        }
        
        .btn-delivered {
            background: #f59e0b;
        }
        
        .btn-delivered:hover {
            background: #d97706;
        }
        
        .input {
            background: #2c2c2e;
            border: none;
            color: #fff;
            padding: 1rem;
            border-radius: 0.75rem;
            width: 100%;
            margin: 0 auto 1rem;
            font-size: 1rem;
            box-shadow: inset 0 0.1rem 0.2rem rgba(0, 0, 0, 0.3);
            transition: all 0.15s ease-out;
            display: block;
            min-height: 3rem;
        }
        
        .input:focus {
            background: #343436;
            outline: none;
        }
        
        .notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 24rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background: #1c1c1e;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
            border-left: 0.25rem solid #34c759;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            visibility: visible;
            animation: notification-bounce 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
        }
        
        @keyframes notification-bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
            40% {transform: translateX(-50%) translateY(-0.5rem);}
            60% {transform: translateX(-50%) translateY(-0.25rem);}
        }
        
        .notification.success {
            border-left-color: #34c759;
            background: #0a3d1c;
        }
        
        .notification.error {
            border-left-color: #ff3b30;
            background: #3d0a0a;
        }
        
        .notification.warning {
            border-left-color: #f59e0b;
            background: #3d2c0a;
        }
        
        .notification.info {
            border-left-color: #007aff;
            background: #0a1e3d;
        }
        
        .notification i {
            font-size: 1.25rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            justify-items: center;
            width: 100%;
        }
        
        .order-item {
            background: #2c2c2e;
            padding: 1rem;
            border-radius: 0.875rem;
            margin-bottom: 0.75rem;
            transition: all 0.15s ease-out;
            width: 100%;
            max-width: 24rem;
            text-align: left;
            will-change: transform;
        }
        
        .order-item h4 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .order-item p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .orders-item {
            background: #2c2c2e;
            padding: 1rem;
            border-radius: 0.875rem;
            margin-bottom: 0.75rem;
            transition: all 0.15s ease-out;
            width: 100%;
            max-width: 24rem;
            text-align: left;
            will-change: transform;
        }

        .orders-item h4 {
            margin: 0 0 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .orders-item p {
            margin: 0.5rem 0;
            font-size: 1.3rem;
            opacity: 0.9;
            text-align: left;
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(44, 44, 46, 0.95);
            backdrop-filter: blur(0.5rem);
            padding: 0.5rem;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -0.25rem 0.5rem rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .footer-nav button {
            background: none;
            color: #a1a1a6;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.15s ease-out;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-width: 3.5rem;
            will-change: transform;
        }
        
        .footer-nav button i {
            font-size: 1rem;
        }
        
        .footer-nav button span {
            display: block;
        }
        
        .footer-nav button.active {
            background: #007aff;
            color: #fff;
            transform: scale(1.05);
        }
        
        .footer-nav button:hover {
            color: #fff;
        }
        
        /* Dashboard styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
            gap: 0.75rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .dashboard-card {
            background: #2c2c2e;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            transition: all 0.15s ease-out;
            min-height: 5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .dashboard-card h3 {
            font-size: 0.85rem;
            font-weight: 500;
            color: #a1a1a6;
            margin-bottom: 0.25rem;
        }
        
        .dashboard-card p {
            font-size: 1.25rem;
            font-weight: 600;
            color: #34c759;
            margin: 0;
        }
        
        /* Loading screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1c1c1e;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        /* Login section */
        #login-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: #1c1c1e;
            z-index: 2000;
        }
        
        .login-container {
            width: 100%;
            max-width: 24rem;
            padding: 1.5rem;
            background: rgba(37, 37, 39, 0.95);
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease-out;
        }
        
        .login-title {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #007aff, #34c759);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .form-group {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem;
            background: #2c2c2e;
            border: none;
            border-radius: 0.75rem;
            color: #fff;
            font-size: 1rem;
            transition: all 0.15s ease;
        }
        
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 68%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .login-btn {
            width: 100%;
            padding: 1rem;
            background: #007aff;
            border: none;
            border-radius: 0.75rem;
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Menu Management Styles */
        .menu-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .menu-item {
            background: #2c2c2e;
            padding: 1rem;
            border-radius: 0.875rem;
            text-align: left;
            transition: all 0.15s ease-out;
        }
        .menu-item h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0 0 0.5rem;
        }
        .menu-item p {
            font-size: 0.95rem;
            opacity: 0.8;
            margin: 0.25rem 0;
            word-wrap: break-word;
        }
        .menu-item .options-toggle {
            color: #007aff;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .menu-item .options-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .menu-item .options-details.show {
            max-height: 10rem;
        }
        .menu-item-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.75rem;
        }
        .menu-item-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            min-height: 2.5rem;
            max-width: 6rem;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #3a3a3c;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 95%;
            max-width: 28rem;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease-out;
            color: #ffffff;
            font-family: 'SF Pro Display', sans-serif;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #007aff, #34c759);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .modal-instructions {
            font-size: 1.1rem;
            opacity: 0.8;
            margin: 0.5rem 0;
        }

        .help-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #5856d6;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 1rem;
            border: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .input {
            background: #4a4a4c;
            border: 2px solid transparent;
            color: #ffffff;
            padding: 1rem;
            border-radius: 1rem;
            width: 100%;
            font-size: 1.3rem;
            box-shadow: inset 0 0.1rem 0.2rem rgba(0, 0, 0, 0.3);
            transition: border 0.2s ease;
        }

        .input:focus {
            border: 2px solid #007aff;
            background: #4a4a4c;
            outline: none;
        }

        .error-message {
            color: #ff3b30;
            font-size: 1rem;
            margin-top: 0.25rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .option-group {
            margin: 1.5rem 0;
            padding: 1.5rem;
            border-radius: 1rem;
            background: #454547;
        }

        .toggle-btn {
            background: #5856d6;
            color: #ffffff;
            padding: 0.75rem;
            border-radius: 0.75rem;
            width: 100%;
            text-align: left;
            font-size: 1.3rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-btn[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }

        .option-list {
            margin-top: 1rem;
            max-height: 12rem;
            overflow-y: auto;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background: #4a4a4c;
        }

        .option-item p {
            flex: 1;
            font-size: 1.2rem;
            margin: 0;
        }

        .option-item .btn {
            padding: 0.75rem;
            min-height: 3rem;
            font-size: 1rem;
            max-width: 3rem;
        }

        .btn {
            padding: 1rem;
            border-radius: 1rem;
            font-size: 1.3rem;
            font-weight: 500;
            text-align: center;
            border: none;
            cursor: pointer;
            width: 100%;
            min-height: 3.5rem;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .btn-save {
            background: #34c759;
        }

        .btn-save:hover {
            background: #2ea44f;
        }

        .btn-cancel {
            background: #ff3b30;
        }

        .btn-cancel:hover {
            background: #dc2626;
        }

        .btn-add {
            background: #007aff;
        }

        .btn-add:hover {
            background: #0062cc;
        }

        .btn-undo {
            background: #f59e0b;
        }

        .btn-undo:hover {
            background: #d97706;
        }

        .help-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(58, 58, 60, 0.95);
            padding: 2rem;
            border-radius: 1.5rem;
            z-index: 10;
        }

        .help-overlay h4 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .help-overlay p {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .btn-close-help {
            background: #007aff;
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            font-size: 1.3rem;
            color: #ffffff;
        }

        @media (max-width: 480px) {
            .section {
                padding: 1rem;
                border-radius: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .footer-nav button {
                min-width: 3rem;
                padding: 0.5rem 0.25rem;
            }
            
            .footer-nav button i {
                font-size: 0.9rem;
            }
            
            .footer-nav button span {
                font-size: 0.7rem;
            }
            
            .modal-content {
                padding: 1.5rem;
                width: 90%;
            }
            
            .modal-header h3 {
                font-size: 1.75rem;
            }
            
            .form-label {
                font-size: 1.3rem;
            }
            
            .input {
                font-size: 1.2rem;
                padding: 0.75rem;
            }
            
            .btn {
                font-size: 1.2rem;
                padding: 0.75rem;
            }
            
            .option-item {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen">
        <h1 style="font-size: 2.5rem; font-weight: 600; letter-spacing: -1px; background: linear-gradient(45deg, #007aff, #34c759, #007aff); -webkit-background-clip: text; background-clip: text; color: transparent;">Chawp</h1>
    </div>

    <!-- Login section -->
    <div id="login-section" class="section" style="display: none;">
        <div class="login-container">
            <h1 class="login-title">Welcome Back</h1>
            <p class="text-center text-gray-400 mb-4">Sign in to manage your restaurant</p>
            <div id="login-notification" class="notification" style="
                position: relative;
                transform: none;
                left: auto;
                top: auto;
                width: 100%;
                margin: 0 auto 1rem;
                animation: none;
            "></div>
            <form id="login-form" novalidate>
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="Enter your email" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <div class="password-container">
                        <input type="password" id="password" class="form-input" placeholder="Enter your password" autocomplete="current-password" minlength="6" required>
                        <button type="button" class="password-toggle" id="toggle-password" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" id="login-btn" class="login-btn">
                    <div class="spinner" id="login-spinner"></div>
                    <span>Sign In</span>
                </button>
            </form>
            <p class="text-center text-gray-400 mt-4 text-sm">Need help? <a href="https://wa.me/233593117766" class="text-blue-400">Contact support</a></p>
        </div>
    </div>

    <div id="main-content" class="container hidden">
        <h1 class="text-3xl font-semibold text-center mb-2"><span id="restaurant-name">Vendor Portal</span></h1>
        <p id="welcome-message" class="text-center text-gray-400 mb-6">Manage your culinary empire with elegance.</p>

        <div id="notification" class="notification"></div>

        <div id="store" class="section">
            <p class="text-center mb-4">Control your shop's status below.</p>
            <div class="flex flex-col gap-2">
                <button id="open-shop-btn" class="btn btn-edit">Open Shop</button>
                <button id="close-shop-btn" class="btn btn-secondary">Close Shop</button>
            </div>
            <p id="shop-status" class="text-center mt-4">Shop Status: <span id="status-text" class="font-semibold">Closed</span></p>
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3">Today's Dashboard</h2>
                <div class="dashboard-grid" id="dashboard-grid"></div>
            </div>
        </div>

        <div id="manage-menu" class="section hidden">
            <h2 class="text-xl font-semibold mb-3">Menu Management</h2>
            <p class="text-center mb-4">Add or update your dishes with ease.</p>
            <button id="add-dish-btn" class="btn">Add New Dish</button>
            <div id="menu-list" class="menu-list"></div>
            <div id="menu-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-title">Add Dish</h3>
                        <p class="modal-instructions">Fill in the dish details below. Save when done!</p>
                        <button class="help-btn" id="help-btn" aria-label="Show help"><i class="fas fa-question-circle"></i> Help</button>
                    </div>
                    <form id="menu-form" novalidate>
                        <div class="form-group">
                            <label for="menu-name" class="form-label">Dish Name</label>
                            <input type="text" id="menu-name" class="input" placeholder="Enter dish name (e.g., Chicken Soup)" required aria-describedby="menu-name-error">
                            <span id="menu-name-error" class="error-message"></span>
                        </div>
                        <div class="form-group">
                            <label for="menu-price" class="form-label">Base Price (GH₵)</label>
                            <input type="number" id="menu-price" class="input" placeholder="Enter price (e.g., 25.00)" step="0.01" min="0" required aria-describedby="menu-price-error">
                            <span id="menu-price-error" class="error-message"></span>
                        </div>
                        <div class="option-group" id="sizes-group">
                            <button type="button" class="toggle-btn" aria-expanded="false" aria-controls="size-list">Sizes <i class="fas fa-chevron-down"></i></button>
                            <div id="size-list" class="option-list hidden"></div>
                            <button type="button" id="add-size-btn" class="btn btn-add"><i class="fas fa-plus"></i> Add Size</button>
                        </div>
                        <div class="option-group" id="extras-group">
                            <button type="button" class="toggle-btn" aria-expanded="false" aria-controls="extra-list">Extras <i class="fas fa-chevron-down"></i></button>
                            <div id="extra-list" class="option-list hidden"></div>
                            <button type="button" id="add-extra-btn" class="btn btn-add"><i class="fas fa-plus"></i> Add Extra</button>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" id="save-dish-btn" class="btn btn-save"><i class="fas fa-save"></i> Save</button>
                            <button type="button" id="cancel-dish-btn" class="btn btn-cancel"><i class="fas fa-times"></i> Cancel</button>
                            <button type="button" id="undo-btn" class="btn btn-undo hidden"><i class="fas fa-undo"></i> Undo</button>
                        </div>
                    </form>
                    <div id="help-overlay" class="help-overlay hidden">
                        <h4>How to Add a Dish</h4>
                        <p>1. Enter the dish name (e.g., "Jollof Rice").</p>
                        <p>2. Add the base price in GH₵ (e.g., 25.00).</p>
                        <p>3. Click "Add Size" or "Add Extra" to include options like "Large" or "Extra Cheese".</p>
                        <p>4. Click "Save" to finish, or "Cancel" to start over.</p>
                        <p>Need more help? <a href="https://wa.me/233509330098" class="text-blue-400">Contact support</a>.</p>
                        <button class="btn btn-close-help" id="btn-close-help">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-orders" class="section hidden">
            <h2 class="text-xl font-semibold mb-3"><u>Active Orders</u></h2>
            <div id="orders-list">Loading orders...</div>
        </div>

        <div id="delivered" class="section hidden">
            <h2 class="text-xl font-semibold mb-3">Delivery Status</h2>
            <div id="delivered-list">Loading delivery status...</div>
        </div>

        <div id="settings" class="section hidden">
            <h2 class="text-xl font-semibold mb-3">Settings</h2>
            <h3 class="text-lg font-semibold mb-2">Manage Store</h3>
            <form id="store-form" class="mb-4">
                <input type="text" id="store-name" placeholder="Store Name" class="input">
                <input type="text" id="store-image" placeholder="Image URL" class="input">
                <button type="submit" class="btn">Update Store</button>
            </form>
            <button id="refresh-app-btn" class="btn" style="background: #5856d6; margin-top: 0.5rem;">Refresh App</button>
           <br><br>
            <button id="logout-btn" class="btn btn-secondary mt-2">Logout</button>
        </div>

        <div class="footer-nav">
            <button id="store-btn" class="active"><i class="fas fa-store"></i><span>Store</span></button>
            <button id="manage-menu-btn"><i class="fas fa-utensils"></i><span>Menu</span></button>
            <button id="view-orders-btn"><i class="fas fa-shopping-cart"></i><span>Orders</span></button>
            <button id="delivered-btn"><i class="fas fa-motorcycle"></i><span>Delivery</span></button>
            <button id="settings-btn"><i class="fas fa-cog"></i><span>Settings</span></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { 
            getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, updateDoc, query, where, onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADvpUQWo75ExePGoCRirD2mM-lmfM4Cmc",
            authDomain: "von600-7982d.firebaseapp.com",
            projectId: "von600-7982d",
            storageBucket: "von600-7982d.appspot.com",
            messagingSenderId: "164591218045",
            appId: "1:164591218045:web:afe17512e16573e7903014",
            measurementId: "G-E69DMPLXBK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let restaurantId = null;

        const loadingScreen = document.getElementById("loading-screen");
        const loginSection = document.getElementById("login-section");
        const mainContent = document.getElementById("main-content");
        const notification = document.getElementById("notification");
        const menuList = document.getElementById("menu-list");
        const ordersList = document.getElementById("orders-list");
        const deliveredList = document.getElementById("delivered-list");
        const dashboardGrid = document.getElementById("dashboard-grid");

        function showNotification(message, type = "success") {
            const notification = document.getElementById("notification");
            if (window.notificationTimer) {
                clearTimeout(window.notificationTimer);
            }
            const icon = type === "error" ? "fa-circle-exclamation" : 
                        type === "warning" ? "fa-triangle-exclamation" : 
                        type === "info" ? "fa-circle-info" : "fa-circle-check";
            notification.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            notification.className = `notification ${type}`;
            void notification.offsetWidth;
            notification.classList.add("show");
            if (type === "error" || type === "warning") {
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU');
                    audio.play().catch(() => {});
                } catch (e) {}
            }
            if (type === "error" && navigator.vibrate) {
                navigator.vibrate(200);
            }
            window.notificationTimer = setTimeout(() => {
                notification.classList.remove("show");
            }, 4000);
        }

        function toggleSection(sectionId) {
            const sections = ["store", "manage-menu", "view-orders", "delivered", "settings"];
            sections.forEach(id => {
                const section = document.getElementById(id);
                const button = document.getElementById(`${id}-btn`);
                if (section && button) {
                    section.classList.toggle("hidden", id !== sectionId);
                    button.classList.toggle("active", id === sectionId);
                }
            });
        }

        async function loadDashboard() {
            if (!restaurantId) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            let activeDeliveries = 0;
            let completedToday = 0;
            const q = query(collection(db, "orders"), where("restaurantId", "==", restaurantId));
            onSnapshot(q, (snapshot) => {
                activeDeliveries = 0;
                completedToday = 0;
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const timestamp = new Date(order.timestamp).getTime();
                    if (order.status === "delivered" && timestamp >= todayTimestamp) {
                        completedToday++;
                    }
                    if (order.status === "being_delivered") {
                        activeDeliveries++;
                    }
                });
                const totalAmountToday = snapshot.docs
                    .filter(doc => {
                        const order = doc.data();
                        const timestamp = new Date(order.timestamp).getTime();
                        return order.status === "delivered" && timestamp >= todayTimestamp;
                    })
                    .reduce((sum, doc) => {
                        const order = doc.data();
                        return sum + order.items.reduce((sub, item) => sub + item.price * item.quantity, 0);
                    }, 0);
                dashboardGrid.innerHTML = `
                    <div class="dashboard-card">
                        <h3>Today's Orders</h3>
                        <p>${completedToday}</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Today's Earnings</h3>
                        <p>GH₵${totalAmountToday.toFixed(2)}</p>
                    </div>
                    <div class="dashboard-card">
                        <h3>Active Deliveries</h3>
                        <p>${activeDeliveries}</p>
                    </div>
                `;
            }, (error) => {
                console.error("Dashboard error:", error);
                dashboardGrid.innerHTML = `<p class='text-gray-400'>Error loading dashboard.</p>`;
            });
        }

        async function loadRestaurantData() {
            if (!restaurantId) return;
            const docRef = doc(db, "restaurant", restaurantId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById("store-name").value = data.name || "";
                document.getElementById("store-image").value = data.image || "";
                document.getElementById("restaurant-name").textContent = `${data.name || "Vendor"}`;
                document.getElementById("welcome-message").textContent = `Manage ${data.name || "your store"} with elegance.`;
                const isOpen = data.isOpen || false;
                document.getElementById("status-text").textContent = isOpen ? "Open" : "Closed";
                document.getElementById("status-text").style.color = isOpen ? "#34c759" : "#ff3b30";
            }
        }

        async function loadMenu() {
            if (!restaurantId) return;
            menuList.innerHTML = "<p class='text-gray-400'>Loading menu...</p>";
            try {
                const menuRef = collection(db, "restaurant", restaurantId, "menu");
                const querySnapshot = await getDocs(menuRef);
                menuList.innerHTML = "";
                if (querySnapshot.empty) {
                    menuList.innerHTML = "<p class='text-gray-400'>No dishes added yet. Add one above!</p>";
                    return;
                }
                querySnapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const item = document.createElement("div");
                    item.className = "menu-item";
                    const hasOptions = (data.sizes?.length > 0) || (data.extras?.length > 0);
                    item.innerHTML = `
                        <h4>${data.name}</h4>
                        <p>Base Price: GH₵${data.price.toFixed(2)}</p>
                        ${hasOptions ? `
                            <div class="options-toggle">Show Options</div>
                            <div class="options-details">
                                ${data.sizes?.length ? `<p><strong>Sizes:</strong> ${data.sizes.map(s => `${s.name} (+GH₵${s.price.toFixed(2)})`).join(", ")}</p>` : ""}
                                ${data.extras?.length ? `<p><strong>Extras:</strong> ${data.extras.map(e => `${e.name} (+GH₵${e.price.toFixed(2)})`).join(", ")}</p>` : ""}
                            </div>
                        ` : ""}
                        <div class="menu-item-actions">
                            <button class="btn btn-edit edit-dish-btn" data-id="${docSnapshot.id}">Edit</button>
                            <button class="btn btn-secondary delete-dish-btn" data-id="${docSnapshot.id}">Delete</button>
                        </div>
                    `;
                    menuList.appendChild(item);
                    if (hasOptions) {
                        const toggle = item.querySelector(".options-toggle");
                        const details = item.querySelector(".options-details");
                        toggle.addEventListener("click", () => {
                            details.classList.toggle("show");
                            toggle.textContent = details.classList.contains("show") ? "Hide Options" : "Show Options";
                        });
                    }
                });

                document.querySelectorAll(".edit-dish-btn").forEach(btn => {
                    btn.addEventListener("click", () => openEditModal(btn.dataset.id));
                });
                document.querySelectorAll(".delete-dish-btn").forEach(btn => {
                    btn.addEventListener("click", () => deleteMenuItem(btn.dataset.id));
                });
            } catch (error) {
                console.error("Error loading menu:", error);
                menuList.innerHTML = "<p class='text-gray-400'>Error loading menu. Please try again.</p>";
                showNotification("Failed to load menu.", "error");
            }
        }

        // Modal state
        let lastDeletedOption = null;
        let hasUnsavedChanges = false;

        // Open modal for adding a dish
        function openAddModal() {
            const modal = document.getElementById("menu-modal");
            const title = document.getElementById("modal-title");
            const form = document.getElementById("menu-form");
            const nameInput = document.getElementById("menu-name");
            const priceInput = document.getElementById("menu-price");
            const sizeList = document.getElementById("size-list");
            const extraList = document.getElementById("extra-list");
            const undoBtn = document.getElementById("undo-btn");

            title.textContent = "Add Dish";
            form.reset();
            sizeList.innerHTML = "";
            extraList.innerHTML = "";
            form.dataset.mode = "add";
            delete form.dataset.id;
            modal.classList.add("show");
            nameInput.focus();
            undoBtn.classList.add("hidden");
            hasUnsavedChanges = false;
            clearErrors();
        }

        // Open modal for editing a dish
        async function openEditModal(menuId) {
            try {
                const docRef = doc(db, "restaurant", restaurantId, "menu", menuId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const modal = document.getElementById("menu-modal");
                    const title = document.getElementById("modal-title");
                    const form = document.getElementById("menu-form");
                    const nameInput = document.getElementById("menu-name");
                    const priceInput = document.getElementById("menu-price");
                    const sizeList = document.getElementById("size-list");
                    const extraList = document.getElementById("extra-list");
                    const undoBtn = document.getElementById("undo-btn");

                    title.textContent = "Edit Dish";
                    nameInput.value = data.name;
                    priceInput.value = data.price.toFixed(2);
                    sizeList.innerHTML = data.sizes?.length
                        ? data.sizes.map((size, index) => `
                            <div class="option-item" data-index="${index}">
                                <p>${size.name} (GH₵${size.price.toFixed(2)})</p>
                                <button type="button" class="btn btn-cancel delete-option-btn" data-type="size" data-index="${index}"><i class="fas fa-trash"></i></button>
                            </div>
                        `).join("")
                        : "";
                    extraList.innerHTML = data.extras?.length
                        ? data.extras.map((extra, index) => `
                            <div class="option-item" data-index="${index}">
                                <p>${extra.name} (GH₵${extra.price.toFixed(2)})</p>
                                <button type="button" class="btn btn-cancel delete-option-btn" data-type="extra" data-index="${index}"><i class="fas fa-trash"></i></button>
                            </div>
                        `).join("")
                        : "";
                    form.dataset.mode = "edit";
                    form.dataset.id = menuId;
                    modal.classList.add("show");
                    nameInput.focus();
                    undoBtn.classList.add("hidden");
                    hasUnsavedChanges = false;
                    clearErrors();
                    attachOptionDeleteListeners();
                } else {
                    showNotification("Dish not found.", "error");
                }
            } catch (error) {
                console.error("Error opening edit modal:", error);
                showNotification("Failed to load dish details.", "error");
            }
        }

        // Close modal
        function closeModal() {
            if (hasUnsavedChanges && !confirm("You have unsaved changes. Close anyway?")) {
                return;
            }
            const modal = document.getElementById("menu-modal");
            modal.classList.remove("show");
            hasUnsavedChanges = false;
        }

        // Clear error messages
        function clearErrors() {
            document.querySelectorAll(".error-message").forEach(el => {
                el.textContent = "";
                el.classList.remove("show");
            });
        }

        // Validate form
        function validateForm(name, price) {
            clearErrors();
            let isValid = true;
            if (!name.trim()) {
                document.getElementById("menu-name-error").textContent = "Please enter a dish name.";
                document.getElementById("menu-name-error").classList.add("show");
                isValid = false;
            }
            if (!price || price < 0 || isNaN(price)) {
                document.getElementById("menu-price-error").textContent = "Please enter a valid price (e.g., 25.00).";
                document.getElementById("menu-price-error").classList.add("show");
                isValid = false;
            }
            return isValid;
        }

        // Add option (size or extra)
        function addOption(type, name, price) {
            const list = document.getElementById(`${type}-list`);
            const index = list.querySelectorAll(".option-item").length;
            list.insertAdjacentHTML("beforeend", `
                <div class="option-item" data-index="${index}">
                    <p>${name} (GH₵${price.toFixed(2)})</p>
                    <button type="button" class="btn btn-cancel delete-option-btn" data-type="${type}" data-index="${index}"><i class="fas fa-trash"></i></button>
                </div>
            `);
            hasUnsavedChanges = true;
            attachOptionDeleteListeners();
        }

        // Delete option with undo
        function deleteOption(btn) {
            const index = parseInt(btn.dataset.index);
            const type = btn.dataset.type;
            const list = document.getElementById(`${type}-list`);
            const item = list.querySelector(`.option-item[data-index="${index}"]`);
            if (!item) return;

            lastDeletedOption = {
                type,
                index,
                name: item.querySelector("p").textContent.split(" (")[0],
                price: parseFloat(item.querySelector("p").textContent.match(/GH₵([\d.]+)/)[1]),
            };
            item.remove();
            document.getElementById("undo-btn").classList.remove("hidden");
            hasUnsavedChanges = true;
        }

        // Undo last deletion
        function undoDelete() {
            if (!lastDeletedOption) return;
            addOption(lastDeletedOption.type, lastDeletedOption.name, lastDeletedOption.price);
            document.getElementById("undo-btn").classList.add("hidden");
            lastDeletedOption = null;
        }

        // Attach delete listeners
        function attachOptionDeleteListeners() {
            document.querySelectorAll(".delete-option-btn").forEach(btn => {
                btn.removeEventListener("click", handleDeleteOption); // Prevent duplicates
                btn.addEventListener("click", handleDeleteOption);
            });
        }

        function handleDeleteOption(e) {
            if (confirm("Delete this option?")) {
                deleteOption(e.target.closest("button"));
            }
        }

        // Toggle option group
        function toggleOptionGroup(btn) {
            const list = document.getElementById(btn.getAttribute("aria-controls"));
            const isExpanded = btn.getAttribute("aria-expanded") === "true";
            btn.setAttribute("aria-expanded", !isExpanded);
            list.classList.toggle("hidden");
        }

        // Show help overlay
        function showHelp() {
            document.getElementById("help-overlay").classList.remove("hidden");
        }

        // Hide help overlay
        function hideHelp() {
            document.getElementById("help-overlay").classList.add("hidden");
        }

        // Delete menu item
        async function deleteMenuItem(menuId) {
            if (!confirm("Are you sure you want to delete this dish? This cannot be undone.")) return;
            try {
                await deleteDoc(doc(db, "restaurant", restaurantId, "menu", menuId));
                showNotification("Dish deleted successfully!", "success");
                loadMenu();
            } catch (error) {
                console.error("Error deleting dish:", error);
                showNotification("Failed to delete dish.", "error");
            }
        }

        // Event listeners for modal
        document.getElementById("add-dish-btn").addEventListener("click", openAddModal);

        document.getElementById("cancel-dish-btn").addEventListener("click", closeModal);

        document.getElementById("undo-btn").addEventListener("click", undoDelete);

        document.getElementById("add-size-btn").addEventListener("click", () => {
            const name = prompt("Enter size name (e.g., Large):");
            if (!name) return;
            const price = prompt("Enter extra price for this size (e.g., 5.00):");
            const parsedPrice = parseFloat(price);
            if (isNaN(parsedPrice) || parsedPrice < 0) {
                showNotification("Please enter a valid price.", "error");
                return;
            }
            addOption("size", name.trim(), parsedPrice);
        });

        document.getElementById("add-extra-btn").addEventListener("click", () => {
            const name = prompt("Enter extra name (e.g., Extra Cheese):");
            if (!name) return;
            const price = prompt("Enter price for this extra (e.g., 2.00):");
            const parsedPrice = parseFloat(price);
            if (isNaN(parsedPrice) || parsedPrice < 0) {
                showNotification("Please enter a valid price.", "error");
                return;
            }
            addOption("extra", name.trim(), parsedPrice);
        });

        document.getElementById("menu-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("menu-name").value.trim();
            const price = parseFloat(document.getElementById("menu-price").value);
            const form = document.getElementById("menu-form");
            const mode = form.dataset.mode;
            const sizeList = document.getElementById("size-list");
            const extraList = document.getElementById("extra-list");

            if (!validateForm(name, price)) return;

            const sizes = Array.from(sizeList.querySelectorAll(".option-item")).map(item => {
                const text = item.querySelector("p").textContent;
                return {
                    name: text.split(" (")[0],
                    price: parseFloat(text.match(/GH₵([\d.]+)/)[1]),
                };
            });
            const extras = Array.from(extraList.querySelectorAll(".option-item")).map(item => {
                const text = item.querySelector("p").textContent;
                return {
                    name: text.split(" (")[0],
                    price: parseFloat(text.match(/GH₵([\d.]+)/)[1]),
                };
            });

            try {
                if (mode === "add") {
                    await addDoc(collection(db, "restaurant", restaurantId, "menu"), { name, price, sizes, extras });
                    showNotification("Dish added successfully!", "success");
                } else if (mode === "edit") {
                    const menuId = form.dataset.id;
                    await updateDoc(doc(db, "restaurant", restaurantId, "menu", menuId), { name, price, sizes, extras });
                    showNotification("Dish updated successfully!", "success");
                }
                closeModal();
                loadMenu();
            } catch (error) {
                console.error(`Error ${mode === "add" ? "adding" : "updating"} dish:`, error);
                showNotification(`Failed to ${mode === "add" ? "add" : "update"} dish.`, "error");
            }
        });

        document.querySelectorAll(".toggle-btn").forEach(btn => {
            btn.addEventListener("click", () => toggleOptionGroup(btn));
        });

        document.getElementById("help-btn").addEventListener("click", showHelp);

        document.getElementById("btn-close-help").addEventListener("click", hideHelp);

        // Track changes
        document.getElementById("menu-form").addEventListener("input", () => {
            hasUnsavedChanges = true;
        });

        function loadOrders() {
            if (!restaurantId) return;
            const q = query(collection(db, "orders"), where("restaurantId", "==", restaurantId));
            onSnapshot(q, (snapshot) => {
                const orders = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(order => order.status !== "being_delivered" && order.status !== "delivered" && order.status !== "not_delivered")
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const fragment = document.createDocumentFragment();
                orders.forEach(order => {
                    const items = order.items.map(item => `${item.quantity}x ${item.name}`).join(", ");
                    const deliveryDetails = order.deliveryDetails || {};
                    const subtotal = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    const item = document.createElement("div");
                    item.className = "orders-item";
                    item.innerHTML = `
                        <div class="order-summary cursor-pointer">
                            <p class="font-bold text-lg text-white">Items: ${items}</p>
                            <p class="font-bold text-lg text-white">Location: ${deliveryDetails.location || "Not provided"}</p>
                            <p class="font-bold text-lg text-white">Total: GH₵${subtotal.toFixed(2)}</p>
                            <button class="btn btn-delivered mark-delivered-btn" data-order-id="${order.id}">Mark as Being Delivered</button>
                        </div>
                        <div class="order-details hidden mt-2">
                            <p class="font-bold text-lg text-white"><u><strong>Other info</strong></u></p>
                            <p><strong>Order ID:</strong> ${order.id}</p>
                            <p><strong>Time:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                            <p><strong>Note:</strong> ${order.note || "None"}</p>
                        </div>
                    `;
                    item.querySelector(".order-summary").addEventListener("click", () => {
                        const details = item.querySelector(".order-details");
                        details.classList.toggle("hidden");
                    });
                    fragment.appendChild(item);
                });
                ordersList.innerHTML = "";
                ordersList.appendChild(fragment);
                if (!orders.length) ordersList.innerHTML = "<p class='text-gray-400'>No pending orders.</p>";
                ordersList.querySelectorAll(".mark-delivered-btn").forEach(btn => btn.addEventListener("click", () => markOrderAsBeingDelivered(btn.dataset.orderId)));
            });
        }

        function loadDeliveredOrders() {
            if (!restaurantId) return;
            const q = query(collection(db, "orders"), where("restaurantId", "==", restaurantId));
            onSnapshot(q, (snapshot) => {
                const orders = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(order => order.status === "delivered" || order.status === "not_delivered")
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const fragment = document.createDocumentFragment();
                orders.forEach(order => {
                    const items = order.items.map(item => `${item.quantity}x ${item.name}`).join(", ");
                    const subtotal = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    const deliveryDetails = order.deliveryDetails || {};
                    const statusColor = order.status === "delivered" ? "#34c759" : "#ff3b30";
                    const item = document.createElement("div");
                    item.className = "order-item";
                    item.innerHTML = `
                        <div class="order-summary cursor-pointer">
                            <p class="font-bold text-lg text-white">Items: ${items}</p>
                            <p class="font-bold text-lg text-white">Total: GH₵${subtotal.toFixed(2)}</p>
                            <p class="font-bold text-lg" style="color: ${statusColor}">Status: ${order.status}</p>
                        </div>
                        <div class="order-details hidden mt-2">
                            <p><strong>Order ID:</strong> ${order.id}</p>
                            <p><strong>Time:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
                            <p><strong>Note:</strong> ${order.note || "None"}</p>
                            <p><strong>Location:</strong> ${deliveryDetails.location || "Not provided"}</p>
                            <p><strong>Delivery Note:</strong> ${deliveryDetails.deliveryNotes || "None"}</p>
                            <p><strong>Contact:</strong> ${deliveryDetails.contactNumber || "Not provided"}</p>
                        </div>
                    `;
                    item.querySelector(".order-summary").addEventListener("click", () => {
                        const details = item.querySelector(".order-details");
                        details.classList.toggle("hidden");
                    });
                    fragment.appendChild(item);
                });
                deliveredList.innerHTML = "";
                deliveredList.appendChild(fragment);
                if (!orders.length) deliveredList.innerHTML = "<p class='text-gray-400'>No delivery status yet.</p>";
            });
        }

        async function markOrderAsBeingDelivered(orderId) {
            await updateDoc(doc(db, "orders", orderId), { status: "being_delivered" });
            showNotification("Order marked as being delivered!");
        }

        document.getElementById("store-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const name = document.getElementById("store-name").value;
            const image = document.getElementById("store-image").value;
            await setDoc(doc(db, "restaurant", restaurantId), { name, image }, { merge: true });
            showNotification("Store updated successfully!");
            loadRestaurantData();
        });

        document.getElementById("open-shop-btn").addEventListener("click", async () => {
            await setDoc(doc(db, "restaurant", restaurantId), { isOpen: true }, { merge: true });
            showNotification("Shop opened!");
            loadRestaurantData();
        });

        document.getElementById("close-shop-btn").addEventListener("click", async () => {
            await setDoc(doc(db, "restaurant", restaurantId), { isOpen: false }, { merge: true });
            showNotification("Shop closed!");
            loadRestaurantData();
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const mappingRef = doc(db, "vendorMappings", user.email);
                const mappingSnap = await getDoc(mappingRef);
                if (mappingSnap.exists()) {
                    restaurantId = mappingSnap.data().restaurantId;
                    loadingScreen.style.display = "none";
                    loginSection.style.display = "none";
                    mainContent.classList.remove("hidden");
                    Promise.all([loadRestaurantData(), loadMenu(), loadOrders(), loadDeliveredOrders(), loadDashboard()]);
                } else {
                    signOut(auth);
                    loadingScreen.style.display = "none";
                    loginSection.style.display = "flex";
                    mainContent.classList.add("hidden");
                    showLoginNotification("No restaurant assigned to this email!", "error");
                }
            } else {
                loadingScreen.style.display = "none";
                loginSection.style.display = "flex";
                mainContent.classList.add("hidden");
                restaurantId = null;
                setTimeout(() => {
                    if (document.getElementById("login-notification")) {
                        showLoginNotification("Please enter your login details", "info");
                    }
                }, 1000);
            }
        });

        document.getElementById("login-form").addEventListener("submit", async function(e) {
            e.preventDefault();
            const emailInput = document.getElementById("email");
            const passwordInput = document.getElementById("password");
            const loginButton = document.getElementById("login-btn");
            const spinner = document.getElementById("login-spinner");
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            emailInput.classList.remove("error");
            passwordInput.classList.remove("error");
            let isValid = true;
            if (!email) {
                showLoginNotification("Email address is required", "error");
                emailInput.classList.add("error");
                isValid = false;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showLoginNotification("Invalid email format", "error");
                emailInput.classList.add("error");
                isValid = false;
            }
            if (!password) {
                showLoginNotification("Password is required", "error");
                passwordInput.classList.add("error");
                isValid = false;
            } else if (password.length < 6) {
                showLoginNotification("Password must be at least 6 characters", "warning");
                passwordInput.classList.add("error");
                isValid = false;
            }
            if (!isValid) return;
            loginButton.disabled = true;
            spinner.style.display = "block";
            loginButton.querySelector("span").textContent = "Signing in...";
            showLoginNotification("Logging in...", "info");
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let errorMessage = "Wrong email or password. Please try again.";
                switch (error.code) {
                    case "auth/user-not-found":
                        errorMessage = "No account found with this email address.";
                        emailInput.classList.add("error");
                        break;
                    case "auth/wrong-password":
                        errorMessage = "Incorrect password. Please try again.";
                        passwordInput.classList.add("error");
                        passwordInput.value = "";
                        passwordInput.focus();
                        break;
                    case "auth/too-many-requests":
                        errorMessage = "Too many failed attempts. Please try again later.";
                        break;
                    case "auth/network-request-failed":
                        errorMessage = "Network error. Please check your connection.";
                        break;
                }
                showLoginNotification(errorMessage, "error");
                loginButton.disabled = false;
                spinner.style.display = "none";
                loginButton.querySelector("span").textContent = "Sign In";
            }
        });

        document.getElementById("toggle-password").addEventListener("click", function() {
            const passwordInput = document.getElementById("password");
            const icon = this.querySelector("i");
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                passwordInput.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        });

        function showLoginNotification(message, type = "error") {
            const notification = document.getElementById("login-notification");
            if (!notification) return;
            if (window.loginNotificationTimer) {
                clearTimeout(window.loginNotificationTimer);
            }
            notification.innerHTML = `
                <i class="fas ${type === "error" ? "fa-exclamation-circle" : 
                                type === "warning" ? "fa-exclamation-triangle" : 
                                type === "info" ? "fa-info-circle" : "fa-check-circle"}"></i>
                <span>${message}</span>
            `;
            notification.className = "notification";
            notification.classList.add(type);
            void notification.offsetWidth;
            notification.style.opacity = "1";
            notification.style.visibility = "visible";
            notification.style.transform = "translateY(0)";
            window.loginNotificationTimer = setTimeout(() => {
                notification.style.opacity = "0";
                notification.style.transform = "translateY(-10px)";
                setTimeout(() => {
                    notification.style.visibility = "hidden";
                }, 300);
            }, 4000);
        }

        function preloadResources() {
            const urls = [
                "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css",
                "https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;500;700&display=swap"
            ];
            urls.forEach(url => {
                const link = document.createElement("link");
                link.rel = "preload";
                link.as = "style";
                link.href = url;
                document.head.appendChild(link);
            });
        }

        preloadResources();

        function setupNavigation() {
            const navButtons = [
                { id: "store-btn", section: "store", load: loadDashboard },
                { id: "manage-menu-btn", section: "manage-menu", load: loadMenu },
                { id: "view-orders-btn", section: "view-orders", load: loadOrders },
                { id: "delivered-btn", section: "delivered", load: loadDeliveredOrders },
                { id: "settings-btn", section: "settings", load: null }
            ];
            navButtons.forEach(({ id, section, load }) => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener("click", () => {
                        toggleSection(section);
                        if (load) load();
                    });
                }
            });
        }

        document.getElementById("logout-btn").addEventListener("click", async () => {
            await signOut(auth);
            showNotification("Logged out successfully!", "success");
        });

        document.getElementById("refresh-app-btn").addEventListener("click", () => {
            if ("caches" in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            location.reload(true);
            showNotification("App refreshed!", "success");
        });

        document.addEventListener("DOMContentLoaded", () => {
            setupNavigation();
        });
    </script>

    <script>
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker.register("/sw.js").then(registration => {
                    console.log("ServiceWorker registration successful");
                    registration.update();
                }).catch(err => {
                    console.log("ServiceWorker registration failed: ", err);
                });
            });
        }

        window.addEventListener("load", () => {
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                document.getElementById("loading-screen").style.display = "none";
            }
        });
    </script>
</body>
</html>